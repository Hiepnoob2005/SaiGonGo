<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ƒêi·ªÉm ƒë·∫øn: Dinh ƒê·ªôc L·∫≠p</title>
  <link rel="stylesheet" href="./assets/css/style.css" />
  <style>
    /* CSS T√πy ch·ªânh */
    body {
      font-family: "Poppins", sans-serif;
      background-color: #f8f8f8;
      text-align: center;
      padding-top: 50px; 
    }

    .main-container {
      max-width: 900px;
      margin: 40px auto;
      padding: 30px;
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    
    .instruction-box {
  margin: 30px auto;
  padding: 30px 35px;
  border: 3px solid #e63946; /* Vi·ªÅn ƒë·ªè n·ªïi b·∫≠t */
  background: linear-gradient(180deg, #fff6f6, #ffeaea); /* n·ªÅn ƒë·ªè nh·∫°t sang tr·ªçng */
  border-radius: 16px;
  text-align: left;
  white-space: pre-wrap; /* Gi·ªØ xu·ªëng d√≤ng */
  font-size: 1.3rem; /* üîπ ch·ªØ to h∆°n r√µ r√†ng */
  line-height: 1.8;  /* üîπ gi√£n d√≤ng d·ªÖ ƒë·ªçc */
  font-weight: 600;
  color: #222; /* ch·ªØ ƒë·∫≠m v·ª´a ph·∫£i */
  box-shadow: 0 6px 18px rgba(230, 57, 70, 0.2);
  min-height: 130px;
  max-width: 800px;
  transition: all 0.3s ease;
}

.instruction-box.show {
  transform: scale(1.02);
  box-shadow: 0 8px 24px rgba(230, 57, 70, 0.35);
}

    /* C√°c n√∫t */
    .btn-action {
  background-color: #d62828;       /* üî¥ ƒë·ªè ƒë·∫≠m */
  color: #fff;                     /* ch·ªØ tr·∫Øng */
  padding: 18px 50px;              /* n√∫t to h∆°n */
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-size: 1.4rem;               /* ch·ªØ l·ªõn h∆°n */
  font-weight: 800;
  letter-spacing: 0.5px;
  transition: all 0.25s ease;
  margin-top: 25px;
  margin-bottom: 15px;
  box-shadow: 0 4px 14px rgba(214, 40, 40, 0.4); /* ƒë·ªï b√≥ng ƒë·ªè nh·∫π */
}

.btn-action:hover {
  background-color: #e63946;       /* ƒë·ªè s√°ng h∆°n khi hover */
  transform: translateY(-3px);     /* hi·ªáu ·ª©ng n·ªïi */
  box-shadow: 0 6px 18px rgba(230, 57, 70, 0.5);
}
    
    .btn-map {
        background-color: #007bff; /* M√†u xanh n·ªïi b·∫≠t cho tr·ª£ gi√∫p */
    }
    .btn-map:hover {
        background-color: #0056b3;
    }
    
    .challenge-section {
        margin-top: 30px;
        padding: 20px;
        border-top: 1px solid #ddd;
    }
    
    /* CSS cho toggle */
    .toggle-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        font-size: 0.95rem;
        color: #555;
    }
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 45px;
        height: 25px;
    }
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 25px;
    }
    .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
    }
    input:checked + .slider {
        background-color: #2196F3;
    }
    input:checked + .slider:before {
        transform: translateX(18px);
    }

  </style>
</head>
<body id="top">
    <header class="header" data-header>
        <div class="container">
            <a href="index.html">
              <h1 class="logo">SaiGonGo</h1>
            </a>
            </div>
    </header>

    <main class="main-container">
        <h2>ƒêi·ªÉm ƒë·∫øn Ti·∫øp theo: Dinh ƒê·ªôc L·∫≠p</h2>
        <p>B∆∞·ªõc 2: S·ª≠ d·ª•ng GPS ƒë·ªÉ l·∫•y ch·ªâ d·∫´n l·ªô tr√¨nh ƒë·∫øn Dinh ƒê·ªôc L·∫≠p.</p>

        <a href="baotang.html" class="btn btn-outline" style="margin: 10px 0 20px 0;">‚Üê Tr·ªü v·ªÅ B·∫£o t√†ng</a>

        <input type="text" id="locationName" value="Dinh ƒê·ªôc L·∫≠p" readonly style="margin-bottom: 20px;" />

        <div class="toggle-container">
            <span>S·ª≠ d·ª•ng v·ªã tr√≠ th·ª±c t·∫ø</span>
            <label class="toggle-switch">
                <input type="checkbox" id="dynamicLocationToggle">
                <span class="slider"></span>
            </label>
            <span id="locationModeLabel">Ch·∫ø ƒë·ªô Th·ª≠ nghi·ªám (B·∫£o t√†ng)</span>
        </div>
        
        <button id="getDirectionsBtn" class="btn-action">‚úÖ Y√™u c·∫ßu L·ªô tr√¨nh GPS</button>

        <div id="loadingStatus" style="margin-top: 15px; color: #ff6600; font-weight: 600;"></div>

        <div id="directionsBox" class="instruction-box">
            L·ªô tr√¨nh s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y sau khi b·∫°n nh·∫•n n√∫t Y√™u c·∫ßu L·ªô tr√¨nh.
        </div>
        
        <a id="mapLink" class="btn-action btn-map" target="_blank" style="display: none; text-decoration: none;">
            M·ªü Map Tr·ª£ gi√∫p
        </a>

        <section class="challenge-section" id="photoChallenge" style="display: none;">
            <h3>Th·ª≠ th√°ch tr√™n ƒë∆∞·ªùng ƒëi</h3>
            <p>Tr∆∞·ªõc khi ƒë·∫øn ƒë√≠ch, h√£y ch·ª•p m·ªôt t·∫•m ·∫£nh c√≥ C√¥ng tr√¨nh n·ªïi b·∫≠t tr√™n tuy·∫øn ƒë∆∞·ªùng n√†y ƒë·ªÉ nh·∫≠n th∆∞·ªüng (V√≠ d·ª•: M·ªôt t∆∞·ª£ng ƒë√†i l·ªõn ho·∫∑c m·ªôt t√≤a nh√† bi·ªÉu t∆∞·ª£ng).</p>
            <a href="destination-dinhdoclap.html" class="btn-action" style="text-decoration: none; background-color: green;">
                Ho√†n th√†nh th·ª≠ th√°ch ·∫£nh ‚Üí
            </a>
        </section>
    </main>
    
    <footer class="footer" style="background-image: url('./assets/images/footer-bg.png')">
        </footer>

    <script>
        const getDirectionsBtn = document.getElementById("getDirectionsBtn");
        const directionsBox = document.getElementById("directionsBox");
        const loadingStatus = document.getElementById("loadingStatus");
        const mapLink = document.getElementById("mapLink");
        const photoChallenge = document.getElementById("photoChallenge");
        const locationToggle = document.getElementById("dynamicLocationToggle"); // M·ªõi
        const locationModeLabel = document.getElementById("locationModeLabel"); // M·ªõi
        const DESTINATION_NAME = document.getElementById("locationName").value;

        let useDynamicLocation = false; // Theo m·∫∑c ƒë·ªãnh c·ªßa Backend: False

        // C·∫≠p nh·∫≠t tr·∫°ng th√°i hi·ªÉn th·ªã c·ªßa c√¥ng t·∫Øc
        locationToggle.checked = !useDynamicLocation; // Backend m·∫∑c ƒë·ªãnh l√† STATIC, n√™n toggle m·∫∑c ƒë·ªãnh l√† checked (cho STATIC)
        locationModeLabel.textContent = locationToggle.checked ? "Ch·∫ø ƒë·ªô Th·ª≠ nghi·ªám (B·∫£o t√†ng)" : "S·ª≠ d·ª•ng v·ªã tr√≠ th·ª±c t·∫ø";


        locationToggle.addEventListener('change', () => {
            useDynamicLocation = !locationToggle.checked;
            locationModeLabel.textContent = locationToggle.checked ? "Ch·∫ø ƒë·ªô Th·ª≠ nghi·ªám (B·∫£o t√†ng)" : "S·ª≠ d·ª•ng v·ªã tr√≠ th·ª±c t·∫ø";
        });


        // H√†m ch√≠nh ƒë·ªÉ l·∫•y v·ªã tr√≠ v√† y√™u c·∫ßu l·ªô tr√¨nh
        function getAndSendLocation() {
            loadingStatus.textContent = "‚è≥ Chu·∫©n b·ªã y√™u c·∫ßu l·ªô tr√¨nh...";
            getDirectionsBtn.disabled = true;
            
            // N·∫øu ng∆∞·ªùi ch∆°i ch·ªçn ch·∫ø ƒë·ªô th·ª≠ nghi·ªám, g·ª≠i t·ªça ƒë·ªô m·∫∑c ƒë·ªãnh (ho·∫∑c null)
            if (!useDynamicLocation) {
                // G·ª≠i t·ªça ƒë·ªô m·∫∑c ƒë·ªãnh (ho·∫∑c null) ƒë·ªÉ Backend d√πng STATIC_START_LOCATION
                fetchDirectionsFromServer(null, null); 
                return;
            }

            // N·∫øu ng∆∞·ªùi ch∆°i ch·ªçn ch·∫ø ƒë·ªô ƒë·ªông, ph·∫£i l·∫•y GPS
            if ("geolocation" in navigator) {
                loadingStatus.textContent = "‚è≥ ƒêang l·∫•y v·ªã tr√≠ GPS hi·ªán t·∫°i...";
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        loadingStatus.textContent = `‚úÖ ƒê√£ l·∫•y v·ªã tr√≠: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                        
                        // G·ª≠i v·ªã tr√≠ th·ª±c t·∫ø ƒë·∫øn server
                        fetchDirectionsFromServer(lat, lon);
                    },
                    (error) => {
                        loadingStatus.textContent = "‚ùå L·ªói: Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠. Vui l√≤ng b·∫≠t GPS.";
                        getDirectionsBtn.disabled = false;
                        console.error(error);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                directionsBox.textContent = "Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã GPS.";
                getDirectionsBtn.disabled = false;
            }
        }

        // H√†m g·ªçi backend ƒë·ªÉ l·∫•y ch·ªâ d·∫´n ƒë·ªông
        async function fetchDirectionsFromServer(lat, lon) {
            loadingStatus.textContent = "‚è≥ ƒêang g·ª≠i t·ªça ƒë·ªô v√† y√™u c·∫ßu AI t·∫°o l·ªô tr√¨nh...";
            
            try {
                const res = await fetch("/get-dynamic-directions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    // G·ª≠i v·ªã tr√≠ hi·ªán t·∫°i (c√≥ th·ªÉ l√† null n·∫øu d√πng ch·∫ø ƒë·ªô tƒ©nh)
                    body: JSON.stringify({ current_lat: lat, current_lon: lon }), 
                });

                const data = await res.json();
                
                if (data.success) {
                    directionsBox.innerHTML = data.route_text.replace(/\n/g, '<br>'); // Thay th·∫ø \n th√†nh <br> ƒë·ªÉ xu·ªëng d√≤ng
                    directionsBox.classList.add("show");
                    loadingStatus.textContent = `üéâ L·ªô tr√¨nh ƒë·∫øn ${DESTINATION_NAME} (${data.distance}) ƒë√£ s·∫µn s√†ng!`;
                    
                    // C·∫≠p nh·∫≠t n√∫t M·ªü Map v√† Th·ª≠ th√°ch
                    mapLink.href = data.map_url;
                    mapLink.style.display = 'inline-block';
                    photoChallenge.style.display = 'block';

                } else {
                    directionsBox.textContent = data.route_text; // Hi·ªÉn th·ªã l·ªói t·ª´ server
                    loadingStatus.textContent = "‚ùå L·ªói t·∫°o l·ªô tr√¨nh.";
                    mapLink.style.display = 'inline-block'; // Hi·ªÉn th·ªã map ƒë·ªÉ tr·ª£ gi√∫p khi l·ªói
                    mapLink.href = `https://www.google.com/maps/dir/`; // Link chung
                }

            } catch (error) {
                console.error("L·ªói Fetch:", error);
                directionsBox.textContent = "‚ùå L·ªói k·∫øt n·ªëi Server. Vui l√≤ng th·ª≠ l·∫°i.";
                loadingStatus.textContent = "‚ùå L·ªói k·∫øt n·ªëi.";

            } finally {
                getDirectionsBtn.disabled = false;
            }
        }

        getDirectionsBtn.addEventListener("click", getAndSendLocation);
        
    </script>

    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
</body>
</html>