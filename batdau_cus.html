<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ƒêi·ªÉm Xu·∫•t Ph√°t - SaiGonGo</title>
  <link rel="stylesheet" href="./assets/css/style.css" />
  <style>
    body {
      font-family: "Times New Roman", Times, serif;
      margin: 0;
      padding: 0;
      background-color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      height: 100vh;
    }

    .container {
      text-align: center;
      padding: 60px 25px;
    }

    h1 {
      font-size: 2.2rem;
      font-weight: 700;
      color: #111;
      margin-bottom: 10px;
    }

    p {
      font-size: 1.2rem;
      color: #555;
      margin-top: 10px;
      margin-bottom: 50px;
    }

    .location-icon {
      font-size: 100px;
      color: #007bff;
      margin-bottom: 35px;
    }

    .place-name {
      font-size: 1.6rem;
      font-weight: 700;
      color: #111;
      margin-bottom: 10px;
    }

    .place-address {
      font-size: 1.15rem;
      color: #444;
      margin-bottom: 18px;
    }

    .map-link {
      color: #007bff;
      text-decoration: none;
      font-weight: 600;
      font-size: 1.2rem;
    }

    .map-link:hover {
      text-decoration: underline;
    }

    .bottom-btn {
      width: 100%;
      text-align: center;
      padding: 25px;
      background: #fff;
      position: fixed;
      bottom: 0;
      left: 0;
      border-top: 1px solid #eee;
    }

    .start-btn {
      background-color: #ff6600;
      color: white;
      border: none;
      border-radius: 12px;
      padding: 18px 80px;
      font-size: 1.3rem;
      cursor: pointer;
      transition: 0.2s;
      font-weight: 700;
      opacity: 0.5;
      pointer-events: none; /* M·∫∑c ƒë·ªãnh kh√≥a n√∫t */
    }

    .start-btn.active {
      opacity: 1;
      pointer-events: auto;
    }

    .distance-info {
      margin-top: 25px;
      font-size: 1.2rem;
      font-weight: 600;
      background: #f0f8ff;
      border-radius: 10px;
      display: inline-block;
      padding: 10px 20px;
    }

    .distance-info.ok {
      background-color: #eaffea;
      color: #0a8a0a;
    }

    .distance-info.far {
      background-color: #fff4e5;
      color: #cc6600;
    }

    /* Toggle Dev Mode Style */
    .toggle-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
      color: #666;
      font-weight: 600;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: #2196F3;
    }

    input:checked+.slider:before {
      transform: translateX(22px);
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>ƒêi·ªÉm xu·∫•t ph√°t</h1>
    <p>H√£y di chuy·ªÉn ƒë·∫øn ƒë·ªãa ƒëi·ªÉm ƒë·∫ßu ti√™n trong l·ªô tr√¨nh c·ªßa b·∫°n.</p>

    <div class="location-icon">üìç</div>

    <div class="place-info">
      <div id="targetName" class="place-name">ƒêang t·∫£i ƒë·ªãa ƒëi·ªÉm...</div>
      <div id="targetAddress" class="place-address">...</div>
      
      <a id="mapLink" class="map-link" href="#" target="_blank">
        üó∫Ô∏è Xem b·∫£n ƒë·ªì
      </a>
    </div>

    <div id="distanceBox" class="distance-info">üì° ƒêang l·∫•y d·ªØ li·ªáu...</div>
    
    {% if is_admin %}
    <div class="toggle-container">
        <span>Ch·∫ø ƒë·ªô ki·ªÉm tra (B·ªè qua GPS)</span>
        <label class="toggle-switch">
          <input type="checkbox" id="devMode">
          <span class="slider"></span>
        </label>
    </div>
    {% endif %}
  </div>

  <div class="bottom-btn">
    <button id="nextBtn" class="start-btn" onclick="goToNextPage()">
      Ti·∫øp t·ª•c
    </button>
  </div>

<script>
    // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u th√¥ng tin ƒëi·ªÉm ƒë·∫øn
    let TARGET_LAT = 0;
    let TARGET_LON = 0;
    let NEXT_URL = "";
    const MAX_DISTANCE = 100; // m√©t (Kho·∫£ng c√°ch cho ph√©p)

    // 1. T·∫£i th√¥ng tin t·ª´ Server ngay khi v√†o trang
    async function loadTarget() {
        try {
            const res = await fetch('/api/get-current-target');
            const data = await res.json();

            if (data.success) {
                // C·∫≠p nh·∫≠t giao di·ªán
                document.getElementById('targetName').textContent = data.name;
                document.getElementById('targetAddress').textContent = data.address;
                
                // C·∫≠p nh·∫≠t bi·∫øn t·ªça ƒë·ªô
                TARGET_LAT = data.lat;
                TARGET_LON = data.lon;
                NEXT_URL = data.next_url; 

                // C·∫≠p nh·∫≠t link Google Maps
                const mapLink = document.getElementById('mapLink');
                mapLink.href = `http://googleusercontent.com/maps.google.com/maps?q=${data.lat},${data.lon}&travelmode=walking`;

                // B·∫Øt ƒë·∫ßu quy tr√¨nh ki·ªÉm tra GPS
                startGPSCheck();
            } else {
                alert("L·ªói: " + data.message);
                window.location.href = "taolotrinh.html"; 
            }
        } catch (e) {
            console.error(e);
            document.getElementById('targetName').textContent = "L·ªói k·∫øt n·ªëi";
        }
    }

    // 2. H√†m t√≠nh kho·∫£ng c√°ch (Haversine Formula)
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3; 
      const toRad = deg => deg * Math.PI / 180;
      const a = Math.sin(toRad(lat2 - lat1) / 2) ** 2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(toRad(lon2 - lon1) / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    // 3. H√†m ki·ªÉm tra v·ªã tr√≠ (Logic ch√≠nh)
    function checkLocation() {
        const distBox = document.getElementById('distanceBox');
        const nextBtn = document.getElementById('nextBtn');
        const devMode = document.getElementById('devMode');

        // üõë ∆Øu ti√™n 1: Ki·ªÉm tra ch·∫ø ƒë·ªô Dev (Ch·ªâ d√†nh cho Admin)
        if (devMode && devMode.checked) {
            distBox.textContent = "üõ†Ô∏è ƒê√£ ƒë·∫øn (Ch·∫ø ƒë·ªô Admin)";
            distBox.className = "distance-info ok";
            nextBtn.classList.add("active"); // M·ªü kh√≥a n√∫t ngay
            return; // D·ª´ng, kh√¥ng c·∫ßn check GPS th·∫≠t
        }

        // üõë ∆Øu ti√™n 2: Ki·ªÉm tra GPS th·ª±c t·∫ø
        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(position => {
                // N·∫øu trong l√∫c ch·ªù GPS m√† admin l·∫°i b·∫≠t Dev Mode th√¨ b·ªè qua k·∫øt qu·∫£ n√†y
                if (devMode && devMode.checked) return;

                const userLat = position.coords.latitude;
                const userLon = position.coords.longitude;
                
                // T√≠nh kho·∫£ng c√°ch
                const d = getDistance(userLat, userLon, TARGET_LAT, TARGET_LON);

                if (d < MAX_DISTANCE) {
                    distBox.textContent = `üéâ B·∫°n ƒë√£ ƒë·∫øn n∆°i!`;
                    distBox.className = "distance-info ok";
                    nextBtn.classList.add("active"); // M·ªü kh√≥a n√∫t
                } else {
                    distBox.textContent = `üìç C√°ch ƒëi·ªÉm ƒë·∫øn: ${Math.round(d)} m√©t`;
                    distBox.className = "distance-info far";
                    nextBtn.classList.remove("active"); // Kh√≥a n√∫t
                }
            }, err => {
                if (devMode && devMode.checked) return;
                distBox.textContent = "‚ùå L·ªói GPS: " + err.message;
            }, { enableHighAccuracy: true });
        } else {
            distBox.textContent = "‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ GPS";
        }
    }

    // 4. Kh·ªüi ƒë·ªông quy tr√¨nh ki·ªÉm tra
    function startGPSCheck() {
        const devMode = document.getElementById('devMode');
        
        // N·∫øu l√† admin, th√™m s·ª± ki·ªán click ƒë·ªÉ check ngay l·∫≠p t·ª©c
        if (devMode) {
            devMode.addEventListener('change', () => {
                // Reset tr·∫°ng th√°i hi·ªÉn th·ªã t·∫°m th·ªùi khi chuy·ªÉn ch·∫ø ƒë·ªô
                if (!devMode.checked) {
                    document.getElementById('distanceBox').textContent = "üì° ƒêang l·∫•y l·∫°i v·ªã tr√≠...";
                    document.getElementById('nextBtn').classList.remove("active");
                }
                checkLocation(); // G·ªçi h√†m check ngay l·∫≠p t·ª©c
            });
        }

        // Ch·∫°y l·∫ßn ƒë·∫ßu
        checkLocation();

        // Ch·∫°y ƒë·ªãnh k·ª≥ m·ªói 3 gi√¢y
        setInterval(checkLocation, 3000);
    }

    // 5. Chuy·ªÉn trang
    function goToNextPage() {
        if (NEXT_URL) {
            window.location.href = NEXT_URL;
        }
    }

    window.onload = loadTarget;
</script>
</body>
</html>