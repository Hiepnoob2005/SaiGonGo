<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="lt_turtle_title">L·ªô tr√¨nh ƒë·∫øn H·ªì Con R√πa</title>
    <link rel="stylesheet" href="./assets/css/style.css" />
    <style>
        /* CSS T√πy ch·ªânh */
        body {
            font-family: "Times New Roman", Times, serif;
            background-color: #f8f8f8;
            text-align: center;
            padding-top: 50px;
        }

        .main-container {
            max-width: 900px;
            margin: 40px auto;
            padding: 30px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .instruction-box {
            margin: 30px auto;
            padding: 30px 35px;
            border: 3px solid #e63946;
            background: linear-gradient(180deg, #fff6f6, #ffeaea);
            border-radius: 16px;
            text-align: left;
            white-space: pre-wrap;
            font-size: 1.5rem;
            line-height: 1.6;
            font-weight: 600;
            color: #222;
            box-shadow: 0 6px 18px rgba(230, 57, 70, 0.2);
            min-height: 130px;
            max-width: 800px;
            transition: all 0.3s ease;
        }

        .instruction-box.show {
            transform: scale(1.02);
            box-shadow: 0 8px 24px rgba(230, 57, 70, 0.35);
        }

        /* C√°c n√∫t */
        .btn-action {
            background-color: #d62828;
            color: #fff;
            padding: 18px 50px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: 0.5px;
            transition: all 0.25s ease;
            margin-top: 25px;
            margin-bottom: 15px;
            box-shadow: 0 4px 14px rgba(214, 40, 40, 0.4);
        }

        .btn-action:hover {
            background-color: #e63946;
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(230, 57, 70, 0.5);
        }

        .btn-map {
            background-color: #007bff;
            padding: 12px 25px;
            font-size: 1rem;
        }

        .btn-map:hover {
            background-color: #0056b3;
        }

        .challenge-section {
            margin-top: 30px;
            padding: 20px;
            border-top: 1px solid #ddd;
        }

        /* CSS cho toggle */
        .toggle-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 0.95rem;
            color: #555;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 45px;
            height: 25px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 25px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #2196F3;
        }

        input:checked+.slider:before {
            transform: translateX(18px);
        }
    </style>
</head>

<body id="top">
    <div id="score-display" class="score-badge">
        üíé <span id="user-points">Loading...</span>
    </div>
    <div id="point-anim" class="point-animation"></div>
    <header class="header" data-header>
        <div class="container">
            <a href="index.html">
                <h1 class="logo">SaiGonGo</h1>
            </a>
        </div>
    </header>

    <main class="main-container">
        <h2 data-i18n="lt_turtle_title">ƒêi·ªÉm ƒë·∫øn Ti·∫øp theo: H·ªì Con R√πa</h2>
        <div id="distanceProgress" style="
          font-size: 1.6rem;
          font-weight: 800;
          color: #0056b3;
          background-color: #e8f2ff;
          border: 2px solid #bcd8ff;
          border-radius: 15px;
          padding: 20px 30px;
          text-align: center;
          margin: 25px auto;
          width: 80%;
          max-width: 500px;
          box-shadow: 0 4px 10px rgba(0,0,0,0.15);
          transition: all 0.3s ease;" data-i18n="lt_locating">
            üìç ƒêang x√°c ƒë·ªãnh v·ªã tr√≠...
        </div>
        <input type="text" id="locationName" value="H·ªì Con R√πa" readonly style="margin-bottom: 20px; display: none;" />
        <a href="quiz_buudientp.html" class="btn btn-outline" style="margin: 10px 0 20px 0;" data-i18n="btn_back">‚Üê Tr·ªü
            v·ªÅ</a>

        {% if is_admin %}

        <div class="toggle-container">
            <span data-i18n="lt_use_real_location">S·ª≠ d·ª•ng v·ªã tr√≠ th·ª±c t·∫ø</span>
            <label class="toggle-switch">
                <input type="checkbox" id="dynamicLocationToggle">
                <span class="slider"></span>
            </label>
            <span id="locationModeLabel">Ch·∫ø ƒë·ªô Th·ª≠ nghi·ªám (H·ªì Con R√πa)</span>
        </div>
        {% endif %}
        <button id="getDirectionsBtn" class="btn-action" data-i18n="btn_request_route">‚úÖ Y√™u c·∫ßu L·ªô tr√¨nh GPS</button>

        <button id="altRouteBtn" class="btn-action" style="background-color: #ff9800; display: none; margin-top: 10px;"
            data-i18n="btn_alt_route">
            ‚ö†Ô∏è N·∫øu ƒë∆∞·ªùng b·ªã ch·∫∑n. T√¨m l·ªëi kh√°c
        </button>

        <div id="loadingStatus" style="margin-top: 15px; color: #ff6600; font-weight: 600;"></div>

        <div id="directionsBox" class="instruction-box" data-i18n="lt_directions_placeholder">
            L·ªô tr√¨nh s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y sau khi b·∫°n nh·∫•n n√∫t Y√™u c·∫ßu L·ªô tr√¨nh.
        </div>

        <a id="mapLink" class="btn-action btn-map" target="_blank" style="display: none; text-decoration: none;">
            <button onclick="openGoogleMap()" data-i18n="btn_open_map">üó∫Ô∏è M·ªü Map Tr·ª£ gi√∫p</button>
        </a>

        <div style="margin-top: 25px;">
            <button id="skipBtn" class="btn-action" style="background-color:#f92929">
                B·ªè qua ƒë·ªãa ƒëi·ªÉm n√†y
            </button>
        </div>

        <section class="challenge-section" id="photoChallenge" style="display: none;">
            <a href="hoconrua.html" class="btn-action" style="text-decoration: none; background-color: green;"
                data-i18n="quiz_continue_turtle">
                Ho√†n th√†nh th·ª≠ th√°ch ‚Üí
            </a>
        </section>
    </main>

    <footer class="footer" style="background-image: url('./assets/images/footer-bg.png')">
    </footer>

    <script>
        // --- 1. L·∫§Y TH√îNG TIN T·ª™ URL ---
        const urlParams = new URLSearchParams(window.location.search);
        const fromKey = urlParams.get('from'); // L·∫•y ƒëi·ªÉm xu·∫•t ph√°t t·ª´ URL

        // --- 2. C·∫§U H√åNH ƒê·ªäA ƒêI·ªÇM ƒê·ªòNG ---
        // N·∫øu c√≥ 'from', d√πng n√≥. N·∫øu kh√¥ng (truy c·∫≠p tr·ª±c ti·∫øp), d√πng m·ªôt ƒëi·ªÉm m·∫∑c ƒë·ªãnh n√†o ƒë√≥ ho·∫∑c b√°o l·ªói
        const START_KEY = fromKey ? fromKey : "buu_dien_thanh_pho";
        const END_KEY = "ho_con_rua"; // ƒêi·ªÉm ƒë·∫øn c·ªßa trang n√†y l√† C·ªê ƒê·ªäNH

        // --- 3. X·ª¨ L√ù N√öT QUAY L·∫†I TH√îNG MINH ---
        // Khi b·∫•m quay l·∫°i, ta mu·ªën v·ªÅ trang Quiz c·ªßa ƒë·ªãa ƒëi·ªÉm tr∆∞·ªõc ƒë√≥
        const backBtn = document.querySelector('a.btn-outline'); // N√∫t "Tr·ªü v·ªÅ"
        if (backBtn && fromKey) {
            // Gi·∫£ s·ª≠ t√™n file quiz l√† quiz_{key}.html (theo quy t·∫Øc ƒë·∫∑t t√™n)
            // Ho·∫∑c b·∫°n c√≥ th·ªÉ g·ªçi API ƒë·ªÉ l·∫•y t√™n file ch√≠nh x√°c n·∫øu mu·ªën ch·∫Øc ch·∫Øn
            backBtn.href = `quiz_${fromKey}.html`;
        }

        const getDirectionsBtn = document.getElementById("getDirectionsBtn");
        const altRouteBtn = document.getElementById("altRouteBtn");
        const directionsBox = document.getElementById("directionsBox");
        const loadingStatus = document.getElementById("loadingStatus");
        const mapLink = document.getElementById("mapLink");
        const photoChallenge = document.getElementById("photoChallenge");
        const locationToggle = document.getElementById("dynamicLocationToggle");
        const locationModeLabel = document.getElementById("locationModeLabel");

        let useDynamicLocation = false;

        // Init Toggle
        locationToggle.checked = !useDynamicLocation;

        function updateLocationLabel() {
            // C·∫ßn th√™m key lt_test_mode_turtle v√†o translations n·∫øu ch∆∞a c√≥
            // T·∫°m d√πng text c·ª©ng n·∫øu ch∆∞a th√™m key, ho·∫∑c d√πng i18n
            if (locationToggle.checked) {
                locationModeLabel.textContent = i18n.t('lt_test_mode_turtle', {}, "Ch·∫ø ƒë·ªô Th·ª≠ nghi·ªám (H·ªì Con R√πa)");
            } else {
                locationModeLabel.textContent = i18n.t('lt_use_real_location');
            }
        }

        locationToggle.addEventListener('change', () => {
            useDynamicLocation = !locationToggle.checked;
            updateLocationLabel();
        });

        window.addEventListener('load', () => {
            if (typeof i18n !== 'undefined') updateLocationLabel();
        });

        // --- H√ÄM 1: X·ª¨ L√ù N√öT B·∫§M & L·∫§Y V·ªä TR√ç ---
        function getAndSendLocation(isAlternative = false) {
            if (isAlternative) {
                loadingStatus.textContent = i18n.t('status_processing');
                altRouteBtn.disabled = true;
            } else {
                loadingStatus.textContent = i18n.t('status_processing');
                getDirectionsBtn.disabled = true;
            }

            if (!useDynamicLocation) {
                fetchDirectionsFromServer(null, null, isAlternative);
                return;
            }

            if ("geolocation" in navigator) {
                if (!isAlternative) loadingStatus.textContent = i18n.t('lt_getting_gps');

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        fetchDirectionsFromServer(lat, lon, isAlternative);
                    },
                    (error) => {
                        console.error(error);
                        loadingStatus.textContent = i18n.t('status_gps_error');
                        getDirectionsBtn.disabled = false;
                        altRouteBtn.disabled = false;
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                directionsBox.textContent = i18n.t('start_browser_error');
                getDirectionsBtn.disabled = false;
                altRouteBtn.disabled = false;
            }
        }

        // --- H√ÄM 2: G·ª¨I API L√äN SERVER ---
        async function fetchDirectionsFromServer(lat, lon, isAlternative) {
            if (!isAlternative) loadingStatus.textContent = i18n.t('lt_creating_route');

            try {
                const res = await fetch("/get-dynamic-directions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        current_lat: lat,
                        current_lon: lon,
                        start: START_KEY,
                        end: END_KEY,
                        alternative: isAlternative,
                    }),
                });

                const data = await res.json();
                const destName = i18n.t('dest_turtle_lake');

                if (data.success) {
                    directionsBox.innerHTML = data.route_text.replace(/\n/g, '<br>');
                    directionsBox.classList.add("show");

                    if (isAlternative) {
                        loadingStatus.textContent = i18n.t('lt_alt_route_found');
                    } else {
                        loadingStatus.textContent = i18n.t('lt_route_ready', { destination: destName, distance: data.total_distance_km });
                        altRouteBtn.style.display = "inline-block";
                    }

                    mapLink.href = data.map_url;
                    mapLink.style.display = 'inline-block';
                    photoChallenge.style.display = 'block';

                } else {
                    directionsBox.innerHTML = data.route_text;
                    loadingStatus.textContent = i18n.t('lt_route_error') + data.message;
                    mapLink.style.display = 'inline-block';
                    mapLink.href = `http://googleusercontent.com/maps.google.com/6{encodeURIComponent(destName)}`;
                }

            } catch (error) {
                console.error("L·ªói Fetch:", error);
                directionsBox.textContent = i18n.t('status_connection_error');
                loadingStatus.textContent = i18n.t('status_error');
            } finally {
                getDirectionsBtn.disabled = false;
                altRouteBtn.disabled = false;
            }
        }

        getDirectionsBtn.addEventListener("click", () => getAndSendLocation(false));
        altRouteBtn.addEventListener("click", () => getAndSendLocation(true));

    </script>

    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <script>
        async function loadUserScore() {
            try {
                const res = await fetch('/api/user');
                const data = await res.json();
                if (data.logged_in) {
                    document.getElementById('user-points').textContent = data.points;
                } else {
                    document.getElementById('score-display').style.display = 'none';
                }
            } catch (e) { console.error(e); }
        }
        window.addEventListener('load', loadUserScore);

        async function openGoogleMap() {
            const start = "B∆∞u ƒëi·ªán TP, 2 C√¥ng x√£ Paris, Qu·∫≠n 1, TP.HCM";
            const destination = "H·ªì Con R√πa, Ph∆∞·ªùng 6, Qu·∫≠n 3, TP.HCM";
            const url = `http://googleusercontent.com/maps.google.com/7{encodeURIComponent(start)}&destination=${encodeURIComponent(destination)}&travelmode=walking`;

            try {
                const res = await fetch('/api/update-score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        points: -2,
                        routeId: 'route1'
                    })
                });
                const data = await res.json();

                if (data.success) {
                    document.getElementById('user-points').textContent = data.new_points;
                    const anim = document.getElementById('point-anim');
                    anim.textContent = i18n.t('score_minus_map');
                    anim.className = "point-animation anim-minus";
                    setTimeout(() => { anim.className = "point-animation"; }, 2000);
                } else {
                    console.log(data.message);
                }
            } catch (e) {
                console.error("L·ªói c·∫≠p nh·∫≠t ƒëi·ªÉm:", e);
            } finally {
                window.open(url, "_blank");
            }
        }
    </script>
    <script>
        const DEST_LAT = 10.782615630794004;
        const DEST_LON = 106.69595372983176;
        const distanceBox = document.getElementById("distanceProgress");

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const toRad = deg => deg * Math.PI / 180;
            const œÜ1 = toRad(lat1);
            const œÜ2 = toRad(lat2);
            const ŒîœÜ = toRad(lat2 - lat1);
            const ŒîŒª = toRad(lon2 - lon1);
            const a = Math.sin(ŒîœÜ / 2) ** 2 +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function updateDistance() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLat = position.coords.latitude;
                        const userLon = position.coords.longitude;
                        const distance = getDistance(userLat, userLon, DEST_LAT, DEST_LON);
                        const km = (distance / 1000).toFixed(2);

                        if (distance < 50) {
                            distanceBox.textContent = i18n.t('lt_arrived');
                            distanceBox.style.backgroundColor = "#e8ffe8";
                            distanceBox.style.color = "#0a8a0a";
                            distanceBox.style.border = "2px solid #9be59b";
                        } else {
                            distanceBox.textContent = i18n.t('lt_distance', { distance: km });
                            distanceBox.style.backgroundColor = "#e8f2ff";
                            distanceBox.style.color = "#0056b3";
                            distanceBox.style.border = "2px solid #bcd8ff";
                        }
                    },
                    (error) => {
                        distanceBox.textContent = i18n.t('lt_gps_error');
                        distanceBox.style.backgroundColor = "#fff4e5";
                        distanceBox.style.color = "#cc6600";
                        distanceBox.style.border = "2px solid #f3c38d";
                    }
                );
            } else {
                distanceBox.textContent = i18n.t('lt_browser_error');
            }
        }

        updateDistance();
        setInterval(updateDistance, 120000);
    </script>


    <script>
        document.getElementById("skipBtn").addEventListener("click", async () => {
            // T√™n key c·ªßa trang hi·ªán t·∫°i
            const CURRENT_KEY = "ho_con_rua";
            // ‚ö†Ô∏è M·ªói trang ƒë·ªïi t√™n n√†y cho ƒë√∫ng!

            try {
                const res = await fetch("/api/get-next-destination", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ current_location: CURRENT_KEY })
                });

                const data = await res.json();

                if (!data.success) {
                    alert("Kh√¥ng th·ªÉ chuy·ªÉn ti·∫øp: " + data.message);
                    return;
                }

                // N·∫øu ƒë√£ h·∫øt l·ªô tr√¨nh
                if (data.finished) {
                    window.location.href = data.next_url;
                    return;
                }

                // Ng∆∞·ª£c l·∫°i ‚Üí ƒë·∫øn trang l·ªô tr√¨nh ti·∫øp theo
                window.location.href = data.next_url;
            }
            catch (err) {
                console.error(err);
                alert("L·ªói k·∫øt n·ªëi server.");
            }
        });
    </script>
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    {% if is_admin %}
    <button onclick="adminSkipAll('hoconrua.html')" class="admin-badge">
        <ion-icon name="rocket-outline"></ion-icon>
        ADMIN SKIP
    </button>

    <script>
        // S·ª≠a h√†m nh·∫≠n tham s·ªë nextUrl
        function adminSkipAll(nextUrl) {
            if (confirm('üöÄ ADMIN: B·ªè qua v√† ƒëi t·ªõi trang ti·∫øp theo ngay?')) {
                // Chuy·ªÉn h∆∞·ªõng ngay l·∫≠p t·ª©c
                window.location.href = nextUrl;
            }
        }
    </script>
    {% endif %}

    <script src="./assets/js/translations.js"></script>
    <script src="./assets/js/i18n.js"></script>

</body>

</html>