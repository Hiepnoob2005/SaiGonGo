<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>L·ªô tr√¨nh ƒë·∫øn H·ªì Con R√πa</title>
  <link rel="stylesheet" href="./assets/css/style.css" />
  <style>
    /* CSS T√πy ch·ªânh */
    body {
      font-family: "Poppins", sans-serif;
      background-color: #f8f8f8;
      text-align: center;
      padding-top: 50px; 
    }

    .main-container {
      max-width: 900px;
      margin: 40px auto;
      padding: 30px;
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    
    .instruction-box {
  margin: 30px auto;
  padding: 30px 35px;
  border: 3px solid #e63946; 
  background: linear-gradient(180deg, #fff6f6, #ffeaea); 
  border-radius: 16px;
  text-align: left;
  white-space: pre-wrap; 
  font-size: 1rem; 
  line-height: 1.6;  
  font-weight: 600;
  color: #222; 
  box-shadow: 0 6px 18px rgba(230, 57, 70, 0.2);
  min-height: 130px;
  max-width: 800px;
  transition: all 0.3s ease;
}

.instruction-box.show {
  transform: scale(1.02);
  box-shadow: 0 8px 24px rgba(230, 57, 70, 0.35);
}

    /* C√°c n√∫t */
    .btn-action {
  background-color: #d62828;       
  color: #fff;                     
  padding: 18px 50px;              
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-size: 1.2rem;               
  font-weight: 800;
  letter-spacing: 0.5px;
  transition: all 0.25s ease;
  margin-top: 25px;
  margin-bottom: 15px;
  box-shadow: 0 4px 14px rgba(214, 40, 40, 0.4); 
}

.btn-action:hover {
  background-color: #e63946;       
  transform: translateY(-3px);     
  box-shadow: 0 6px 18px rgba(230, 57, 70, 0.5);
}
    
    .btn-map {
        background-color: #007bff; 
        padding: 12px 25px;
        font-size: 1rem;
    }
    .btn-map:hover {
        background-color: #0056b3;
    }
    
    .challenge-section {
        margin-top: 30px;
        padding: 20px;
        border-top: 1px solid #ddd;
    }
    
    /* CSS cho toggle */
    .toggle-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        font-size: 0.95rem;
        color: #555;
    }
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 45px;
        height: 25px;
    }
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 25px;
    }
    .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
    }
    input:checked + .slider {
        background-color: #2196F3;
    }
    input:checked + .slider:before {
        transform: translateX(18px);
    }

  </style>
</head>
<body id="top">
    <header class="header" data-header>
        <div class="container">
            <a href="index.html">
              <h1 class="logo">SaiGonGo</h1>
            </a>
            </div>
    </header>

    <main class="main-container">
        <h2>ƒêi·ªÉm ƒë·∫øn Ti·∫øp theo: H·ªì Con R√πa</h2>
        <div id="distanceProgress" style="
  font-size: 1.6rem;
  font-weight: 800;
  color: #0056b3;
  background-color: #e8f2ff;
  border: 2px solid #bcd8ff;
  border-radius: 15px;
  padding: 20px 30px;
  text-align: center;
  margin: 25px auto;
  width: 80%;
  max-width: 500px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  transition: all 0.3s ease;
">
  üìç ƒêang x√°c ƒë·ªãnh v·ªã tr√≠...
</div>
        <a href="quiz_buudientp.html" class="btn btn-outline" style="margin: 10px 0 20px 0;">‚Üê Tr·ªü v·ªÅ</a>

        <input type="text" id="locationName" value="H·ªì Con R√πa" readonly style="margin-bottom: 20px;" />

        <div class="toggle-container">
            <span>S·ª≠ d·ª•ng v·ªã tr√≠ th·ª±c t·∫ø</span>
            <label class="toggle-switch">
                <input type="checkbox" id="dynamicLocationToggle">
                <span class="slider"></span>
            </label>
            <span id="locationModeLabel">Ch·∫ø ƒë·ªô Th·ª≠ nghi·ªám (H·ªì Con R√πa)</span>
        </div>
        
        <button id="getDirectionsBtn" class="btn-action">‚úÖ Y√™u c·∫ßu L·ªô tr√¨nh GPS</button>

        <div id="loadingStatus" style="margin-top: 15px; color: #ff6600; font-weight: 600;"></div>

        <div id="directionsBox" class="instruction-box">
            L·ªô tr√¨nh s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y sau khi b·∫°n nh·∫•n n√∫t Y√™u c·∫ßu L·ªô tr√¨nh.
        </div>
        
        <a id="mapLink" class="btn-action btn-map" target="_blank" style="display: none; text-decoration: none;">
            <button onclick="openGoogleMap()">üó∫Ô∏è M·ªü Map Tr·ª£ gi√∫p</button>
        </a>

        <section class="challenge-section" id="photoChallenge" style="display: none;">
            <a href="hoconrua.html" class="btn-action" style="text-decoration: none; background-color: green;">
                Ho√†n th√†nh th·ª≠ th√°ch ‚Üí
            </a>
        </section>
    </main>
    
    <footer class="footer" style="background-image: url('./assets/images/footer-bg.png')">
        </footer>

    <script>
        // --- C·∫§U H√åNH ƒê·ªäA ƒêI·ªÇM ---
        const START_KEY = "buu_dien_thanh_pho";
        const END_KEY = "ho_con_rua";
        // -------------------------

        const getDirectionsBtn = document.getElementById("getDirectionsBtn");
        const directionsBox = document.getElementById("directionsBox");
        const loadingStatus = document.getElementById("loadingStatus");
        const mapLink = document.getElementById("mapLink");
        const photoChallenge = document.getElementById("photoChallenge");
        const locationToggle = document.getElementById("dynamicLocationToggle"); 
        const locationModeLabel = document.getElementById("locationModeLabel"); 
        const DESTINATION_NAME = document.getElementById("locationName").value;

        let useDynamicLocation = false;

        locationToggle.checked = !useDynamicLocation;
        locationModeLabel.textContent = locationToggle.checked ? "Ch·∫ø ƒë·ªô Th·ª≠ nghi·ªám (B∆∞u ƒëi·ªán Th√†nh Ph·ªë)" : "S·ª≠ d·ª•ng v·ªã tr√≠ th·ª±c t·∫ø";


        locationToggle.addEventListener('change', () => {
            useDynamicLocation = !locationToggle.checked;
            locationModeLabel.textContent = locationToggle.checked ? "Ch·∫ø ƒë·ªô Th·ª≠ nghi·ªám (B∆∞u ƒëi·ªán Th√†nh Ph·ªë)" : "S·ª≠ d·ª•ng v·ªã tr√≠ th·ª±c t·∫ø";
        });


        function getAndSendLocation() {
            loadingStatus.textContent = "‚è≥ Chu·∫©n b·ªã y√™u c·∫ßu l·ªô tr√¨nh...";
            getDirectionsBtn.disabled = true;
            
            if (!useDynamicLocation) {
                // Ch·∫ø ƒë·ªô tƒ©nh: Ch·ªâ g·ª≠i key ƒë·ªÉ backend d√πng t·ªça ƒë·ªô tƒ©nh
                fetchDirectionsFromServer(null, null); 
                return;
            }

            if ("geolocation" in navigator) {
                loadingStatus.textContent = "‚è≥ ƒêang l·∫•y v·ªã tr√≠ GPS hi·ªán t·∫°i...";
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        loadingStatus.textContent = `‚úÖ ƒê√£ l·∫•y v·ªã tr√≠: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                        
                        // G·ª≠i v·ªã tr√≠ th·ª±c t·∫ø ƒë·∫øn server
                        fetchDirectionsFromServer(lat, lon);
                    },
                    (error) => {
                        loadingStatus.textContent = "‚ùå L·ªói: Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠. Vui l√≤ng b·∫≠t GPS.";
                        getDirectionsBtn.disabled = false;
                        console.error(error);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                directionsBox.textContent = "Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã GPS.";
                getDirectionsBtn.disabled = false;
            }
        }

        async function fetchDirectionsFromServer(lat, lon) {
            loadingStatus.textContent = "‚è≥ ƒêang g·ª≠i t·ªça ƒë·ªô v√† y√™u c·∫ßu AI t·∫°o l·ªô tr√¨nh...";
            
            try {
                const res = await fetch("/get-dynamic-directions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ 
                        current_lat: lat, 
                        current_lon: lon,
                        // TRUY·ªÄN KEY ƒê·ªäA ƒêI·ªÇM L√äN BACKEND
                        start: START_KEY,
                        end: END_KEY
                    }), 
                });

                const data = await res.json();
                
                if (data.success) {
                    directionsBox.innerHTML = data.route_text.replace(/\n/g, '<br>'); 
                    directionsBox.classList.add("show");
                    loadingStatus.textContent = `üéâ L·ªô tr√¨nh ƒë·∫øn ${DESTINATION_NAME} (${data.total_distance_km} km) ƒë√£ s·∫µn s√†ng!`;
                    
                    mapLink.href = data.map_url;
                    mapLink.style.display = 'inline-block';
                    photoChallenge.style.display = 'block';

                } else {
                    directionsBox.innerHTML = data.route_text; 
                    loadingStatus.textContent = "‚ùå L·ªói t·∫°o l·ªô tr√¨nh: " + data.message;
                    mapLink.style.display = 'inline-block';
                    mapLink.href = `https://www.google.com/maps/dir/`; 
                }

            } catch (error) {
                console.error("L·ªói Fetch:", error);
                directionsBox.textContent = "‚ùå L·ªói k·∫øt n·ªëi Server. Vui l√≤ng th·ª≠ l·∫°i.";
                loadingStatus.textContent = "‚ùå L·ªói k·∫øt n·ªëi.";

            } finally {
                getDirectionsBtn.disabled = false;
            }
        }

        getDirectionsBtn.addEventListener("click", getAndSendLocation);
        
    </script>

    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
<script>
  function openGoogleMap() {
    // ‚öôÔ∏è ƒêi·ªÉm b·∫Øt ƒë·∫ßu v√† ƒë√≠ch (b·∫°n c√≥ th·ªÉ ƒë·ªïi tu·ª≥ n∆°i)
    const start = "B∆∞u ƒëi·ªán TP, 2 C√¥ng x√£ Paris, Qu·∫≠n 1, TP.HCM";
    const destination = "H·ªì Con R√πa, Ph∆∞·ªùng 6, Qu·∫≠n 3, TP.HCM";

    // üó∫Ô∏è T·∫°o link Google Maps v·ªõi mode = walking
    const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(start)}&destination=${encodeURIComponent(destination)}&travelmode=walking`;

    // üöÄ M·ªü Google Maps trong tab m·ªõi
    window.open(url, "_blank");
  }
</script>
<script>

// üéØ T·ªça ƒë·ªô c·ªßa ƒëi·ªÉm ƒë·∫øn (v√≠ d·ª•: H·ªì Con R√πa)
const DEST_LAT = 10.782615630794004;
const DEST_LON = 106.69595372983176;


const distanceBox = document.getElementById("distanceProgress");

// H√†m t√≠nh kho·∫£ng c√°ch gi·ªØa 2 t·ªça ƒë·ªô (m√©t)
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3; // b√°n k√≠nh Tr√°i ƒê·∫•t (m)
  const toRad = deg => deg * Math.PI / 180;
  const œÜ1 = toRad(lat1);
  const œÜ2 = toRad(lat2);
  const ŒîœÜ = toRad(lat2 - lat1);
  const ŒîŒª = toRad(lon2 - lon1);
  const a = Math.sin(ŒîœÜ / 2) ** 2 +
            Math.cos(œÜ1) * Math.cos(œÜ2) *
            Math.sin(ŒîŒª / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

// üîÑ H√†m c·∫≠p nh·∫≠t ti·∫øn ƒë·ªô
function updateDistance() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;
        const distance = getDistance(userLat, userLon, DEST_LAT, DEST_LON);
        const km = (distance / 1000).toFixed(2);

        if (distance < 50) {
          distanceBox.textContent = "üéâ B·∫°n ƒë√£ ƒë·∫øn ƒëi·ªÉm ƒë·∫øn r·ªìi!";
          distanceBox.style.backgroundColor = "#e8ffe8";
          distanceBox.style.color = "#0a8a0a";
          distanceBox.style.border = "2px solid #9be59b";
        } else {
          distanceBox.textContent = `üìç C√°ch ƒëi·ªÉm ƒë·∫øn: ${km} km`;
          distanceBox.style.backgroundColor = "#e8f2ff";
          distanceBox.style.color = "#0056b3";
          distanceBox.style.border = "2px solid #bcd8ff";
        }
      },
      (error) => {
        distanceBox.textContent = "‚ö†Ô∏è Kh√¥ng th·ªÉ x√°c ƒë·ªãnh v·ªã tr√≠. H√£y b·∫≠t GPS.";
        distanceBox.style.backgroundColor = "#fff4e5";
        distanceBox.style.color = "#cc6600";
        distanceBox.style.border = "2px solid #f3c38d";
      }
    );
  } else {
    distanceBox.textContent = "‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ GPS.";
  }
}

// G·ªçi ngay v√† c·∫≠p nh·∫≠t m·ªói 2 ph√∫t
updateDistance();
setInterval(updateDistance, 120000);
</script>

</body>
</html>