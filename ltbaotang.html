<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="lt_museum_title">L·ªô tr√¨nh ƒë·∫øn B·∫£o t√†ng Chi·∫øn t√≠ch Chi·∫øn Tranh</title>
    <link rel="stylesheet" href="./assets/css/style.css" />
    <link rel="stylesheet" href="./assets/css/lotrinh_SAME_style.css" />
</head>

<body id="top">
    <div id="score-display" class="score-badge">
        üíé <span id="user-points">Loading...</span>
    </div>
    <div id="point-anim" class="point-animation"></div>
    <header class="header" data-header>
        <div class="container">
            <a href="index.html">
                <h1 class="logo">SaiGonGo</h1>
            </a>
        </div>
    </header>

    <main class="main-container">
        <h2 data-i18n="lt_museum_title">ƒêi·ªÉm ƒë·∫øn Ti·∫øp theo: B·∫£o t√†ng Ch·ª©ng t√≠ch Chi·∫øn Tranh</h2>
        <div id="distanceProgress" style="
            font-size: 1.6rem;
            font-weight: 800;
            color: #0056b3;
            background-color: #e8f2ff;
            border: 2px solid #bcd8ff;
            border-radius: 15px;
            padding: 20px 30px;
            text-align: center;
            margin: 25px auto;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
" data-i18n="lt_locating">
            üìç ƒêang x√°c ƒë·ªãnh v·ªã tr√≠...
        </div>
        <input type="text" id="locationName" value="B·∫£o t√†ng Ch·ª©ng t√≠ch Chi·∫øn Tranh" readonly
            style="margin-bottom: 20px; display: none;" />
        <a href="ltbaotang.html" class="btn btn-outline" style="margin: 10px 0 20px 0;" data-i18n="btn_back">‚Üê Tr·ªü
            v·ªÅ</a>

        {% if is_admin %}

        <div class="toggle-container">
            <span data-i18n="lt_use_real_location">S·ª≠ d·ª•ng v·ªã tr√≠ th·ª±c t·∫ø</span>
            <label class="toggle-switch">
                <input type="checkbox" id="dynamicLocationToggle">
                <span class="slider"></span>
            </label>
            <span id="locationModeLabel" data-i18n="lt_test_mode">Ch·∫ø ƒë·ªô Th·ª≠ nghi·ªám</span>
        </div>
        {% endif %}

        <button id="getDirectionsBtn" class="btn-action" data-i18n="btn_request_route">‚úÖ Y√™u c·∫ßu L·ªô tr√¨nh GPS</button>

        <button id="altRouteBtn" class="btn-action" style="background-color: #ff9800; display: none; margin-top: 10px;"
            data-i18n="btn_alt_route">
            ‚ö†Ô∏è N·∫øu ƒë∆∞·ªùng b·ªã ch·∫∑n. T√¨m l·ªëi kh√°c
        </button>

        <div id="loadingStatus" style="margin-top: 15px; color: #ff6600; font-weight: 600;"></div>

        <div id="directionsBox" class="instruction-box" data-i18n="lt_route_placeholder">
            L·ªô tr√¨nh s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y sau khi b·∫°n nh·∫•n n√∫t Y√™u c·∫ßu L·ªô tr√¨nh.
        </div>

        <button id="btnOpenMap" class="btn-action btn-map" onclick="openGoogleMap()"
            style="display: none; background-color: #2196F3;" data-i18n="btn_open_map">
            üó∫Ô∏è M·ªü Map Tr·ª£ gi√∫p
        </button>

        <div style="margin-top: 25px;">
            <button id="skipBtn" class="btn-action" style="background-color:#f92929" data-i18n="btn_skip_location">
                B·ªè qua ƒë·ªãa ƒëi·ªÉm n√†y
            </button>
        </div>

        <section class="challenge-section" id="photoChallenge" style="display: none;">
            <a href="baotang.html" class="btn-action" style="text-decoration: none; background-color: green;" data-i18n="btn_continue_general">
                Ti·∫øp t·ª•c ‚Üí
            </a>
        </section>
    </main>

    <footer class="footer" style="background-image: url('./assets/images/footer-bg.png')">
    </footer>

    <script>
        // 1. Khai b√°o urlParams TR∆Ø·ªöC TI√äN
        const urlParams = new URLSearchParams(window.location.search);
        // Th√™m d√≤ng n√†y ·ªü ƒë·∫ßu ph·∫ßn <script>
        let dynamicMapUrl = "";
        // 2. L·∫•y c√°c th√¥ng tin c·∫ßn thi·∫øt
        const fromKey = urlParams.get('from');
        const isRoute1 = urlParams.get('mode') === 'route1';

        // 3. X√ÅC ƒê·ªäNH ƒêI·ªÇM B·∫ÆT ƒê·∫¶U (START_KEY)
        let START_KEY;

        if (isRoute1) {
            // üëâ TR∆Ø·ªúNG H·ª¢P 1: L·ªò TR√åNH 1 (C·ªê ƒê·ªäNH)
            // Trong l·ªô tr√¨nh 1, tr∆∞·ªõc Dinh ƒê·ªôc L·∫≠p LU√îN LU√îN l√† B·∫£o T√†ng.
            // N√™n ta g√°n c·ª©ng lu√¥n, kh√¥ng c·∫ßn quan t√¢m 'from'.
            START_KEY = "bao_tang_chien_tich";
        } else {
            // üëâ TR∆Ø·ªúNG H·ª¢P 2: T·ª∞ T·∫†O L·ªò TR√åNH (ƒê·ªòNG)
            // Ph·∫£i l·∫•y t·ª´ bi·∫øn 'from' tr√™n URL.
            if (fromKey) {
                START_KEY = fromKey;
            } else {
                // N·∫øu kh√¥ng c√≥ 'from' (do l·ªói truy·ªÅn tham s·ªë), ta m·ªõi d√πng t·∫°m m·∫∑c ƒë·ªãnh
                console.warn("Thi·∫øu tham s·ªë 'from', d√πng m·∫∑c ƒë·ªãnh.");
                START_KEY = "bao_tang_chien_tich";
            }
        }

        const END_KEY = "bao_tang_chien_tich";

        window.addEventListener('load', () => {
            const challengeBtn = document.querySelector('#photoChallenge a');
            if (challengeBtn && isRoute1) {
                // Truy·ªÅn ti·∫øp mode=route1
                challengeBtn.href = `baotang.html?mode=route1`;
            } else if (challengeBtn && urlParams.get('from')) {
                // Logic ƒë·ªông c≈©
                challengeBtn.href = `baotang.html?from=${urlParams.get('from')}`;
            }
        });

        const getDirectionsBtn = document.getElementById("getDirectionsBtn");
        const altRouteBtn = document.getElementById("altRouteBtn");
        const directionsBox = document.getElementById("directionsBox");
        const loadingStatus = document.getElementById("loadingStatus");
        const photoChallenge = document.getElementById("photoChallenge");
        const locationToggle = document.getElementById("dynamicLocationToggle");
        const locationModeLabel = document.getElementById("locationModeLabel");

        let useDynamicLocation = false;

        // Init Toggle
        locationToggle.checked = !useDynamicLocation;

        function updateLocationLabel() {
            if (locationToggle.checked) {
                locationModeLabel.textContent = i18n.t('lt_test_mode_post');
            } else {
                locationModeLabel.textContent = i18n.t('lt_use_real_location');
            }
        }

        locationToggle.addEventListener('change', () => {
            useDynamicLocation = !locationToggle.checked;
            updateLocationLabel();
        });


        // --- H√ÄM 1: X·ª¨ L√ù N√öT B·∫§M & L·∫§Y V·ªä TR√ç ---
        function getAndSendLocation(isAlternative = false) {
            // 1. C·∫≠p nh·∫≠t giao di·ªán (Loading)
            if (isAlternative) {
                loadingStatus.textContent = i18n.t('status_processing');
                altRouteBtn.disabled = true;
            } else {
                loadingStatus.textContent = i18n.t('status_processing');
                getDirectionsBtn.disabled = true;
            }

            // 2. Ki·ªÉm tra ch·∫ø ƒë·ªô (Tƒ©nh hay ƒê·ªông)
            if (!useDynamicLocation) {
                // Ch·∫ø ƒë·ªô tƒ©nh: G·ª≠i null ƒë·ªÉ server t·ª± l·∫•y t·ªça ƒë·ªô m·∫´u
                fetchDirectionsFromServer(null, null, isAlternative);
                return;
            }

            // 3. Ch·∫ø ƒë·ªô ƒê·ªông (GPS th·ª±c t·∫ø)
            if ("geolocation" in navigator) {
                if (!isAlternative) loadingStatus.textContent = i18n.t('lt_getting_gps');

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        fetchDirectionsFromServer(lat, lon, isAlternative);
                    },
                    (error) => {
                        console.error(error);
                        loadingStatus.textContent = i18n.t('status_gps_error');
                        getDirectionsBtn.disabled = false;
                        altRouteBtn.disabled = false;
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                directionsBox.textContent = i18n.t('start_browser_error');
                getDirectionsBtn.disabled = false;
                altRouteBtn.disabled = false;
            }
        }

        // --- H√ÄM 2: G·ª¨I API L√äN SERVER ---
        async function fetchDirectionsFromServer(lat, lon, isAlternative) {
            if (!isAlternative) loadingStatus.textContent = i18n.t('lt_creating_route');

            try {
                const res = await fetch("/get-dynamic-directions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        current_lat: lat,
                        current_lon: lon,
                        start: START_KEY,
                        end: END_KEY,
                        alternative: isAlternative,
                        // --- TH√äM D√íNG N√ÄY ---
                        lang: i18n.currentLanguage
                    }),
                });

                const data = await res.json();
                // T√™n ƒë·ªãa ƒëi·ªÉm ƒë√≠ch cho th√¥ng b√°o
                // C√≥ th·ªÉ c·∫ßn th√™m key dest_post_office v√†o translations
                const destName = i18n.t('dest_museum');

                if (data.success) {
                    directionsBox.innerHTML = data.route_text.replace(/\n/g, '<br>');
                    directionsBox.classList.add("show");
                    dynamicMapUrl = data.map_url;
                    document.getElementById("btnOpenMap").style.display = 'inline-block';

                    if (isAlternative) {
                        loadingStatus.textContent = i18n.t('lt_alt_route_found');
                    } else {
                        loadingStatus.textContent = i18n.t('lt_route_ready', { destination: destName, distance: data.total_distance_km });
                        altRouteBtn.style.display = "inline-block";
                    }

                    photoChallenge.style.display = 'block';

                } else {
                    directionsBox.innerHTML = data.route_text;
                    loadingStatus.textContent = i18n.t('lt_route_error') + data.message;
                }

            } catch (error) {
                console.error("L·ªói Fetch:", error);
                directionsBox.textContent = i18n.t('status_connection_error');
                loadingStatus.textContent = i18n.t('status_error');
            } finally {
                getDirectionsBtn.disabled = false;
                altRouteBtn.disabled = false;
            }
        }

        getDirectionsBtn.addEventListener("click", () => getAndSendLocation(false));
        altRouteBtn.addEventListener("click", () => getAndSendLocation(true));

    </script>

    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <script>
        // --- 1. H√ÄM LOAD ƒêI·ªÇM KHI V√ÄO TRANG ---
        async function loadUserScore() {
            try {
                const res = await fetch('/api/user');
                const data = await res.json();
                if (data.logged_in) {
                    document.getElementById('user-points').textContent = data.points;
                } else {
                    document.getElementById('score-display').style.display = 'none';
                }
            } catch (e) { console.error(e); }
        }
        window.addEventListener('load', loadUserScore);

        async function openGoogleMap() {
            // Ki·ªÉm tra xem ƒë√£ c√≥ link ch∆∞a
            if (!dynamicMapUrl) {
                alert("Vui l√≤ng b·∫•m 'Y√™u c·∫ßu L·ªô tr√¨nh' ƒë·ªÉ l·∫•y ƒë∆∞·ªùng ƒëi tr∆∞·ªõc!");
                return;
            }

            // G·ªçi API tr·ª´ ƒëi·ªÉm (-2 ƒëi·ªÉm)
            try {
                // L·∫•y ID l·ªô tr√¨nh t·ª´ URL (ƒë·ªÉ bi·∫øt ƒëang ch∆°i route n√†o)
                const urlParams = new URLSearchParams(window.location.search);
                const isRoute1 = urlParams.get('mode') === 'route1';
                const routeId = isRoute1 ? 'route1' : 'custom'; // Ho·∫∑c logic ID c·ªßa b·∫°n

                const res = await fetch('/api/update-score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        points: -2,
                        routeId: routeId
                    })
                });
                const data = await res.json();

                if (data.success) {
                    // C·∫≠p nh·∫≠t ƒëi·ªÉm tr√™n m√†n h√¨nh
                    document.getElementById('user-points').textContent = data.new_points;

                    // Hi·ªáu ·ª©ng tr·ª´ ƒëi·ªÉm
                    const anim = document.getElementById('point-anim');
                    anim.textContent = "-2 ƒêi·ªÉm (Xem Map)";
                    anim.className = "point-animation anim-minus";
                    setTimeout(() => { anim.className = "point-animation"; }, 2000);
                }
            } catch (e) {
                console.error("L·ªói c·∫≠p nh·∫≠t ƒëi·ªÉm:", e);
            } finally {
                // üî• QUAN TR·ªåNG: M·ªü link ƒë·ªông l·∫•y t·ª´ Server
                window.open(dynamicMapUrl, "_blank");
            }
        }
    </script>
    <script>
        // üéØ T·ªça ƒë·ªô c·ªßa ƒëi·ªÉm ƒë·∫øn (v√≠ d·ª•: B·∫£o t√†ng Ch·ª©ng t√≠ch Chi·∫øn tranh)
        const DEST_LAT = 10.779487;
        const DEST_LON = 106.69228;

        const distanceBox = document.getElementById("distanceProgress");

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const toRad = deg => deg * Math.PI / 180;
            const œÜ1 = toRad(lat1);
            const œÜ2 = toRad(lat2);
            const ŒîœÜ = toRad(lat2 - lat1);
            const ŒîŒª = toRad(lon2 - lon1);
            const a = Math.sin(ŒîœÜ / 2) ** 2 +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function updateDistance() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLat = position.coords.latitude;
                        const userLon = position.coords.longitude;
                        const distance = getDistance(userLat, userLon, DEST_LAT, DEST_LON);
                        const km = (distance / 1000).toFixed(2);

                        if (distance < 50) {
                            distanceBox.textContent = i18n.t('lt_arrived');
                            distanceBox.style.backgroundColor = "#e8ffe8";
                            distanceBox.style.color = "#0a8a0a";
                            distanceBox.style.border = "2px solid #9be59b";
                        } else {
                            distanceBox.textContent = i18n.t('lt_distance', { distance: km });
                            distanceBox.style.backgroundColor = "#e8f2ff";
                            distanceBox.style.color = "#0056b3";
                            distanceBox.style.border = "2px solid #bcd8ff";
                        }
                    },
                    (error) => {
                        distanceBox.textContent = i18n.t('lt_gps_error');
                        distanceBox.style.backgroundColor = "#fff4e5";
                        distanceBox.style.color = "#cc6600";
                        distanceBox.style.border = "2px solid #f3c38d";
                    }
                );
            } else {
                distanceBox.textContent = i18n.t('lt_browser_error');
            }
        }

        updateDistance();
        setInterval(updateDistance, 120000);
    </script>

    <script src="./assets/js/translations.js"></script>
    <script src="./assets/js/i18n.js"></script>
    <script src="./assets/js/api-helper.js"></script>

    <script>
        document.getElementById("skipBtn").addEventListener("click", async () => {
        // T√™n key c·ªßa trang hi·ªán t·∫°i
        const CURRENT_KEY = "bao_tang_chien_tich";

        // --- 1. KI·ªÇM TRA CH·∫æ ƒê·ªò ---
        const urlParams = new URLSearchParams(window.location.search);
        const isRoute1 = urlParams.get('mode') === 'route1';

        // --- 2. N·∫æU L√Ä ROUTE 1 (Tƒ®NH) ---
        if (isRoute1) {
            // L·ªô tr√¨nh 1: Nh√† Th·ªù -> B∆∞u ƒêi·ªán
            // Chuy·ªÉn th·∫≥ng ƒë·∫øn trang l·ªô tr√¨nh ti·∫øp theo + k√®m tham s·ªë mode
            window.location.href = 'ltbaotang.html?mode=route1';
            return;
        }

        // --- 3. N·∫æU L√Ä T·ª∞ CH·ªåN (ƒê·ªòNG - API) ---
        try {
            const res = await fetch("/api/get-next-destination", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ current_location: CURRENT_KEY }),
            });

            const data = await res.json();

            if (!data.success) {
                alert("Kh√¥ng th·ªÉ chuy·ªÉn ti·∫øp: " + data.message);
                return;
            }

            if (data.finished) {
                window.location.href = data.next_url;
                return;
            }

            window.location.href = data.next_url;
        }
        catch (err) {
            console.error(err);
            alert("L·ªói k·∫øt n·ªëi server.");
        }
    });
    </script>

    </script>
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    
    {% if is_admin %}
    <button onclick="adminSkipAll('baotang.html')" class="admin-badge">
        <ion-icon name="rocket-outline"></ion-icon>
        ADMIN SKIP
    </button>

    <script>
        function adminSkipAll(nextUrl) {
            if (confirm('üöÄ ADMIN: B·ªè qua v√† ƒëi t·ªõi trang ti·∫øp theo ngay?')) {
                // Chuy·ªÉn h∆∞·ªõng ngay l·∫≠p t·ª©c
                const urlParams = new URLSearchParams(window.location.search);
                const mode = urlParams.get('mode');

                if (mode === 'route1') {
                    // N·∫øu c√≥ mode, n·ªëi th√™m v√†o link ti·∫øp theo
                    // Ki·ªÉm tra xem nextUrl ƒë√£ c√≥ d·∫•u ? ch∆∞a
                    const separator = nextUrl.includes('?') ? '&' : '?';
                    window.location.href = `baotang.html?mode=route1`;
                } else {
                    // N·∫øu kh√¥ng, ƒëi b√¨nh th∆∞·ªùng
                    window.location.href = nextUrl;
                }
            }
        }
    </script>
    {% endif %}

    <script src="./assets/js/translations.js"></script>
    <script src="./assets/js/i18n.js"></script>

</body>

</html>