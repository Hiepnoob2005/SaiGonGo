<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="quiz_palace_title">Truy t√¨m hi·ªán v·∫≠t - Dinh ƒê·ªôc L·∫≠p</title>
  <style>
    :root {
      --primary: #ff7043;
      --secondary: #4a90e2;
      --success: #66bb6a;
      --bg: #fffaf0;
      --card-bg: #ffffff;
      --text: #333;
    }

    body {
      font-family: "Times New Roman", Times, serif;
      background: linear-gradient(135deg, #fffaf0, #ffe0b2);
      margin: 0;
      padding: 20px;
      color: var(--text);
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: var(--card-bg);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    header { text-align: center; margin-bottom: 30px; }
    h1 { color: var(--primary); margin-bottom: 5px; }
    p.subtitle { color: #666; font-size: 0.95rem; }

    .progress-container {
      background: #eee; height: 20px; border-radius: 10px;
      overflow: hidden; margin: 20px 0; position: relative;
    }
    .progress-bar {
      height: 100%; background: var(--success); width: 0%;
      transition: width 0.5s ease;
    }
    .progress-text {
      position: absolute; width: 100%; text-align: center; top: 0;
      font-size: 12px; font-weight: bold; color: #333; line-height: 20px;
    }

    .grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px;
    }

    .card {
      background: #fff; border: 2px solid #eee; border-radius: 15px;
      padding: 15px; text-align: center; cursor: pointer; transition: all 0.3s;
      position: relative; overflow: hidden;
    }
    .card:hover { transform: translateY(-3px); border-color: var(--secondary); }
    .card.completed { border-color: var(--success); background: #f0fdf4; }
    .card.completed::after {
      content: "‚úì"; position: absolute; top: 5px; right: 5px;
      background: var(--success); color: white; width: 20px; height: 20px;
      border-radius: 50%; font-size: 12px; display: flex; align-items: center; justify-content: center;
    }

    .icon { font-size: 2rem; margin-bottom: 10px; display: block; }
    .card-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 5px; }
    .card-hint { font-size: 0.75rem; color: #777; }

    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;
    }
    .modal-content {
      background: white; padding: 25px; border-radius: 20px;
      width: 90%; max-width: 400px; text-align: center;
    }
    .modal-img-preview {
      width: 100%; max-height: 250px; object-fit: cover;
      border-radius: 10px; margin: 15px 0; background: #eee; display: none;
    }
    
    .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; margin: 5px; width: 100%; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: #ccc; color: #333; }
    .btn-danger { background: transparent; border: 1px solid #ef5350; color: #ef5350; font-size: 0.8rem; margin-top: 10px; }

    #nextStep { display: none; margin-top: 30px; text-align: center; }
    .loader {
      border: 4px solid #f3f3f3; border-top: 4px solid var(--primary);
      border-radius: 50%; width: 30px; height: 30px;
      animation: spin 1s linear infinite; margin: 10px auto; display: none;
    }
        /* --- POINT --- */
    .score-badge {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 8px 15px;
      border-radius: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      font-weight: bold;
      font-size: 1rem;
      color: #333;
      z-index: 999;
      border: 2px solid var(--primary);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    /* Hi·ªáu ·ª©ng ƒëi·ªÉm bay l√™n */
    .point-animation {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      font-size: 4rem;
      font-weight: 800;
      color: #ffca28; /* M√†u v√†ng */
      text-shadow: 0 0 10px rgba(0,0,0,0.3);
      pointer-events: none;
      z-index: 2000;
      opacity: 0;
      transition: all 0.5s ease-out;
    }

    .point-animation.active {
      transform: translate(-50%, -150%) scale(1.2);
      opacity: 1;
    }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    /* --- ADMIN BUTTON STYLE --- */
    .admin-badge {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 24px;
      border-radius: 50px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      z-index: 10000;
      font-weight: bold;
      font-family: sans-serif; /* D√πng font kh√¥ng ch√¢n cho hi·ªán ƒë·∫°i */
      display: flex;
      align-items: center;
      gap: 10px;
      border: 2px solid white;
      cursor: pointer;
      transition: transform 0.2s;
      text-decoration: none; /* ƒê·ªÅ ph√≤ng n·∫øu th·∫ª l√† th·∫ª a */
    }

    .admin-badge:hover {
      transform: scale(1.05) translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }

    .admin-badge ion-icon {
      font-size: 1.4rem;
    }
</style>
</head>
<body>

<div class="container">
  <a href="dinhdoclap.html" style="text-decoration: none; color: var(--primary); font-weight: bold;" data-i18n="btn_back">‚Üê Quay l·∫°i</a>
  
  <header>
    <h1 data-i18n="quiz_palace_title">üè∞ Spot the Detail: Dinh ƒê·ªôc L·∫≠p</h1>
    <p class="subtitle" data-i18n="quiz_palace_subtitle">T√¨m v√† ch·ª•p √≠t nh·∫•t <b>3 hi·ªán v·∫≠t</b> ƒë·ªÉ ho√†n th√†nh nhi·ªám v·ª•!</p>
    
    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
      <div class="progress-text" id="progressText" data-i18n="quiz_progress" data-i18n-params='{"count": 0}'>0/3 Ho√†n th√†nh</div>
    </div>
  </header>

  <div class="grid" id="gridContainer"></div>

  <div id="nextStep">
    <h3 data-i18n="quiz_complete_title">üéâ Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh th·ª≠ th√°ch.</h3>
    <p data-i18n="quiz_complete_text">B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c ƒëi·ªÉm th∆∞·ªüng cho s·ª± quan s√°t tinh t·∫ø.</p>
    <button class="btn btn-primary" onclick="window.location.href='ltnhathoducba.html'" data-i18n="quiz_continue_cathedral">Ti·∫øp t·ª•c h√†nh tr√¨nh ‚Üí</button>
  </div>

  <script>
const urlParams = new URLSearchParams(window.location.search);
const isRoute1 = urlParams.get('mode') === 'route1';
async function goToNextStop(currentKey) {
    // 1. L·∫§Y THAM S·ªê T·ª™ URL ƒê·ªÇ KI·ªÇM TRA CH·∫æ ƒê·ªò
    const urlParams = new URLSearchParams(window.location.search);
    const isRoute1 = urlParams.get('mode') === 'route1';

    // 2. N·∫æU L√Ä L·ªò TR√åNH 1 (Tƒ®NH) -> ƒêI TH·∫≤NG ƒê·∫æN LINK C·ªê ƒê·ªäNH
    if (isRoute1) {
        // ƒêi·ªÉm ti·∫øp theo c·ªßa B·∫£o t√†ng trong Route 1 l√† Dinh ƒê·ªôc L·∫≠p
        // Quan tr·ªçng: Ph·∫£i k√®m theo ?mode=route1 ƒë·ªÉ trang sau bi·∫øt
        window.location.href = 'ltnhathoducba.html?mode=route1'; 
        return; // D·ª´ng h√†m, kh√¥ng g·ªçi API n·ªØa
    }

    // 3. N·∫æU L√Ä L·ªò TR√åNH T·ª∞ CH·ªåN (ƒê·ªòNG) -> G·ªåI API
    const btn = document.querySelector('#nextStep button');
    if(btn) {
        btn.disabled = true;
        btn.textContent = "‚è≥ ƒêang l·∫•y l·ªô tr√¨nh...";
    }

    try {
        const res = await fetch('/api/get-next-destination', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ current_location: currentKey })
        });
        
        const data = await res.json();
        
        if (data.success) {
            if (data.finished) {
                window.location.href = data.next_url; 
            } else {
                window.location.href = data.next_url;
            }
        } else {
            alert("L·ªói: " + data.message);
            if(btn) btn.disabled = false;
        }
    } catch (e) {
        console.error(e);
        alert("L·ªói k·∫øt n·ªëi.");
        if(btn) btn.disabled = false;
    }
}

</script>

</div>

<div class="modal" id="cameraModal">
  <div class="modal-content">
    <h3 id="modalTitle">T√™n hi·ªán v·∫≠t</h3>
    <p id="modalHint" style="font-size: 0.9rem; color: #666;">G·ª£i √Ω v·ªã tr√≠...</p>
    
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
    <img id="preview" class="modal-img-preview">
    
    <div id="actionButtons">
      <button class="btn btn-primary" onclick="document.getElementById('cameraInput').click()" data-i18n="btn_take_photo">üì∏ Ch·ª•p ·∫£nh ngay</button>
      <button class="btn btn-secondary" onclick="closeModal()" data-i18n="btn_close">ƒê√≥ng</button>
      <button class="btn btn-danger" onclick="reportMissing()" data-i18n="btn_report_missing">‚ö†Ô∏è T√¥i kh√¥ng t√¨m th·∫•y (B√°o c√°o)</button>
    </div>

    <div id="verifySection" style="display:none;">
      <div class="loader" id="loader"></div>
      <p id="statusMsg" data-i18n="quiz_analyzing">ƒêang ph√¢n t√≠ch...</p>
      <button class="btn btn-primary" id="confirmBtn" style="display:none;" onclick="closeModal()" data-i18n="btn_great">Tuy·ªát v·ªùi!</button>
      <button class="btn btn-secondary" id="retryBtn" style="display:none;" onclick="resetModal()" data-i18n="btn_retry">Th·ª≠ l·∫°i</button>
    </div>
  </div>
</div>

<script>
  // DANH S√ÅCH HI·ªÜN V·∫¨T CHO DINH ƒê·ªòC L·∫¨P (Ch·ªâ gi·ªØ ID v√† Icon)
  // C√°c key text t∆∞∆°ng ·ª©ng s·∫Ω l√†: artifact_tank_390, artifact_tank_390_hint...
  const details = [
    { id: 'tank_390', icon: 'üöú' },
    { id: 'fountain_dinh', icon: '‚õ≤' },
    { id: 'stone_curtain', icon: 'üß±' },
    { id: 'cabinet_room', icon: 'üõãÔ∏è' },
    { id: 'banquet_hall', icon: 'üç∑' },
    { id: 'mercedes_car', icon: 'üöó' },
    { id: 'helicopter_roof', icon: 'üöÅ' }
  ];

  let completedCount = 0;
  const targetCount = 3;
  let currentDetailId = null;
  const completedDetails = new Set();

  const grid = document.getElementById('gridContainer');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const modal = document.getElementById('cameraModal');

  function initGrid() {
    grid.innerHTML = '';
    details.forEach(item => {
      // D√πng i18n ƒë·ªÉ l·∫•y t√™n v√† hint
      const name = i18n.t('artifact_' + item.id);
      const hint = i18n.t('artifact_' + item.id + '_hint');

      const card = document.createElement('div');
      card.className = `card ${completedDetails.has(item.id) ? 'completed' : ''}`;
      card.onclick = () => openModal(item, name, hint);
      card.innerHTML = `<span class="icon">${item.icon}</span><div class="card-title">${name}</div><div class="card-hint">${hint}</div>`;
      grid.appendChild(card);
    });
    updateProgress();
  }

  function updateProgress() {
    const pct = (completedCount / targetCount) * 100;
    progressBar.style.width = `${Math.min(pct, 100)}%`;
    progressText.innerText = i18n.t('quiz_progress', {count: completedCount});
    if (completedCount >= targetCount) document.getElementById('nextStep').style.display = 'block';
  }

  function openModal(item, name, hint) {
    if (completedDetails.has(item.id)) return;
    currentDetailId = item.id;
    document.getElementById('modalTitle').innerText = name;
    document.getElementById('modalHint').innerText = hint;
    resetModal();
    modal.style.display = 'flex';
  }

  function closeModal() { modal.style.display = 'none'; }
  function resetModal() {
    document.getElementById('preview').style.display = 'none';
    document.getElementById('preview').src = '';
    document.getElementById('actionButtons').style.display = 'block';
    document.getElementById('verifySection').style.display = 'none';
    document.getElementById('cameraInput').value = '';
  }

  function reportMissing() {
    if(confirm(i18n.t('quiz_report_confirm'))) {
      document.getElementById('cameraInput').setAttribute('data-mode', 'missing');
      document.getElementById('cameraInput').click();
    }
  }

  document.getElementById('cameraInput').addEventListener('change', function() {
      const isMissingMode = this.getAttribute('data-mode') === 'missing';
      this.removeAttribute('data-mode');
      if (this.files && this.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('preview').src = e.target.result;
            document.getElementById('preview').style.display = 'block';
            uploadAndVerify(this.files[0], isMissingMode);
        };
        reader.readAsDataURL(this.files[0]);
      }
  });

  async function uploadAndVerify(file, isReportMissing) {
    document.getElementById('actionButtons').style.display = 'none';
    document.getElementById('verifySection').style.display = 'block';
    document.getElementById('loader').style.display = 'block';
    document.getElementById('statusMsg').innerText = isReportMissing ? i18n.t('quiz_checking_scene') : i18n.t('quiz_analyzing');

    // ‚úÖ D√πng ServerAPI - t·ª± ƒë·ªông g·ª≠i ng√¥n ng·ªØ hi·ªán t·∫°i
    try {
      const data = await ServerAPI.verifyDetail(file, currentDetailId, isReportMissing);
      document.getElementById('loader').style.display = 'none';
      
      if (data.success) {
        if (data.data && data.data.valid) {
            const correctMsg = i18n.t('quiz_correct');
            const funFactLabel = i18n.t('quiz_fun_fact');
            document.getElementById('statusMsg').innerHTML = `${correctMsg}<br><br><b>${funFactLabel}</b><br>${data.data.fact}`;
            markCompleted();
        } else if (data.status === 'skipped') {
            const skippedMsg = i18n.t('quiz_skipped');
            document.getElementById('statusMsg').innerHTML = `${skippedMsg}<br>${data.message}`;
            markCompleted();
        } else {
            const wrongMsg = i18n.t('quiz_wrong');
            const reason = data.data ? data.data.reason : data.message;
            document.getElementById('statusMsg').innerHTML = `${wrongMsg}<br>${reason}`;
            document.getElementById('retryBtn').style.display = 'inline-block';
        }
      } else {
        document.getElementById('statusMsg').innerText = `‚ùå ${data.message}`;
        document.getElementById('retryBtn').style.display = 'inline-block';
      }
    } catch (err) {
      document.getElementById('statusMsg').innerText = i18n.t('quiz_connection_error');
      document.getElementById('retryBtn').style.display = 'inline-block';
    }
  }

  function markCompleted() {
    if (completedDetails.has(currentDetailId)) return;
    completedDetails.add(currentDetailId);
    completedCount++;
    document.getElementById('confirmBtn').style.display = 'inline-block';
    initGrid();
  }

  // Reload grid on language change
  window.addEventListener('languageChanged', () => {
      initGrid();
  });

  window.addEventListener('load', () => {
       if(typeof i18n !== 'undefined') initGrid();
  });
    // --- 1. H√ÄM M·ªöI: C·ªòNG ƒêI·ªÇM V√Ä T·∫†O HI·ªÜU ·ª®NG ---
  async function addScore(points) {
    try {
      // G·ªçi API backend main.py
      const res = await fetch('/api/update-score', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ points: points, routeId: 'route1' })
      });
      const data = await res.json();

      if (data.success) {
        // C·∫≠p nh·∫≠t s·ªë ƒëi·ªÉm hi·ªÉn th·ªã tr√™n g√≥c
        document.getElementById('user-points').textContent = data.new_points;

        // Ch·∫°y hi·ªáu ·ª©ng +2 bay l√™n
        const anim = document.getElementById('point-anim');
        anim.textContent = '+' + points;
        anim.classList.add('active');
        
        // Reset hi·ªáu ·ª©ng sau 1 gi√¢y
        setTimeout(() => {
          anim.classList.remove('active');
        }, 1000);
      }
    } catch (e) {
      console.error("L·ªói c·ªông ƒëi·ªÉm:", e);
    }
  }

  // --- 2. H√ÄM M·ªöI: T·∫¢I ƒêI·ªÇM L√öC ƒê·∫¶U (ƒë·ªÉ hi·ªÉn th·ªã ƒë√∫ng s·ªë ƒëi·ªÉm hi·ªán c√≥) ---
  async function loadInitialScore() {
    try {
      const res = await fetch('/api/user');
      const data = await res.json();
      if (data.logged_in) {
        document.getElementById('user-points').textContent = data.points;
      }
    } catch (e) { console.error(e); }
  }
  // G·ªçi h√†m n√†y khi t·∫£i trang
  window.addEventListener('load', loadInitialScore);


  // --- 3. S·ª¨A H√ÄM uploadAndVerify (T√¨m h√†m c≈© v√† thay th·∫ø ƒëo·∫°n x·ª≠ l√Ω th√†nh c√¥ng) ---
  async function uploadAndVerify(file, isReportMissing) {
    document.getElementById('actionButtons').style.display = 'none';
    document.getElementById('verifySection').style.display = 'block';
    document.getElementById('loader').style.display = 'block';
    document.getElementById('statusMsg').innerText = isReportMissing ? i18n.t('quiz_checking_scene') : i18n.t('quiz_analyzing');
    
    const formData = new FormData();
    formData.append('image', file);
    formData.append('detail_id', currentDetailId);
    formData.append('report_missing', isReportMissing);

    try {
      const res = await fetch('/api/verify-detail', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      
      document.getElementById('loader').style.display = 'none';
      
      if (data.success) {
        // TR∆Ø·ªúNG H·ª¢P 1: AI X√ÅC NH·∫¨N ƒê√öNG V·∫¨T TH·ªÇ
        if (data.data && data.data.valid) {
            const correctMsg = i18n.t('quiz_correct');
            const funFactLabel = i18n.t('quiz_fun_fact');
            
            document.getElementById('statusMsg').innerHTML = `${correctMsg}<br><br><b>${funFactLabel}</b><br>${data.data.fact}`;
            
            // >>> TH√äM D√íNG N√ÄY: C·ªông 2 ƒëi·ªÉm <<<
            addScore(2); 

            markCompleted();
        
        // TR∆Ø·ªúNG H·ª¢P 2: B√ÅO C√ÅO M·∫§T TH√ÄNH C√îNG (C≈©ng ƒë∆∞·ª£c t√≠nh l√† ƒë√∫ng)
        } else if (data.status === 'skipped') {
             const skippedMsg = i18n.t('quiz_skipped');
             document.getElementById('statusMsg').innerHTML = `${skippedMsg}<br>${data.message}`;
             
             // >>> TH√äM D√íNG N√ÄY: C·ªông 2 ƒëi·ªÉm an ·ªßi/ch√≠nh x√°c <<<
             addScore(2);

             markCompleted();
        } else {
            // SAI -> Kh√¥ng c·ªông ƒëi·ªÉm
            const wrongMsg = i18n.t('quiz_wrong');
            const reason = data.data ? data.data.reason : data.message;
            document.getElementById('statusMsg').innerHTML = `${wrongMsg}<br>${reason}`;
            document.getElementById('retryBtn').style.display = 'inline-block';
        }
      } else {
        document.getElementById('statusMsg').innerText = `‚ùå ${data.message}`;
        document.getElementById('retryBtn').style.display = 'inline-block';
      }
    } catch (err) {
      console.error(err);
      document.getElementById('statusMsg').innerText = i18n.t('quiz_connection_error');
      document.getElementById('retryBtn').style.display = 'inline-block';
    }
  }
</script>
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

{% if is_admin %}
  <button onclick="adminSkipTest('dinh_doc_lap')" class="admin-badge">
    <ion-icon name="rocket-outline"></ion-icon>
    ADMIN SKIP
  </button>

  <script>
    function adminSkipTest(currentKey) {
      if(confirm('üöÄ ADMIN: B·ªè qua v√† g·ªçi API l·∫•y ƒëi·ªÉm ti·∫øp theo?')) {
        // H√†m n√†y gi·ªù ƒë√£ th√¥ng minh h∆°n, n√≥ s·∫Ω t·ª± chia nh√°nh Route 1 ho·∫∑c Custom
        goToNextStop(currentKey);
      }
    }
  </script>
  {% endif %}

<script src="./assets/js/translations.js"></script>
<script src="./assets/js/i18n.js"></script>
<script src="./assets/js/api-helper.js"></script>

</body>
</html>