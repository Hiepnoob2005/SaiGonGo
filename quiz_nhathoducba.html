<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Truy t√¨m hi·ªán v·∫≠t - Nh√† th·ªù ƒê·ª©c B√†</title>
  <style>
    :root { --primary: #ff7043; --secondary: #4a90e2; --success: #66bb6a; --bg: #fffaf0; --card-bg: #ffffff; --text: #333; }
    body { font-family: "Be Vietnam Pro", sans-serif; background: linear-gradient(135deg, #fffaf0, #ffe0b2); margin: 0; padding: 20px; color: var(--text); }
    .container { max-width: 800px; margin: 0 auto; background: var(--card-bg); border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    header { text-align: center; margin-bottom: 30px; }
    h1 { color: var(--primary); margin-bottom: 5px; }
    p.subtitle { color: #666; font-size: 0.95rem; }
    .progress-container { background: #eee; height: 20px; border-radius: 10px; overflow: hidden; margin: 20px 0; position: relative; }
    .progress-bar { height: 100%; background: var(--success); width: 0%; transition: width 0.5s ease; }
    .progress-text { position: absolute; width: 100%; text-align: center; top: 0; font-size: 12px; font-weight: bold; color: #333; line-height: 20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
    .card { background: #fff; border: 2px solid #eee; border-radius: 15px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; }
    .card:hover { transform: translateY(-3px); border-color: var(--secondary); }
    .card.completed { border-color: var(--success); background: #f0fdf4; }
    .card.completed::after { content: "‚úì"; position: absolute; top: 5px; right: 5px; background: var(--success); color: white; width: 20px; height: 20px; border-radius: 50%; font-size: 12px; display: flex; align-items: center; justify-content: center; }
    .icon { font-size: 2rem; margin-bottom: 10px; display: block; }
    .card-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 5px; }
    .card-hint { font-size: 0.75rem; color: #777; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; }
    .modal-img-preview { width: 100%; max-height: 250px; object-fit: cover; border-radius: 10px; margin: 15px 0; background: #eee; display: none; }
    .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; margin: 5px; width: 100%; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: #ccc; color: #333; }
    .btn-danger { background: transparent; border: 1px solid #ef5350; color: #ef5350; font-size: 0.8rem; margin-top: 10px; }
    #nextStep { display: none; margin-top: 30px; text-align: center; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; display: none; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div class="container">
  <a href="nhathoducba.html" style="text-decoration: none; color: var(--primary); font-weight: bold;">‚Üê Quay l·∫°i</a>
  
  <header>
    <h1>‚õ™ Spot the Detail: Nh√† th·ªù ƒê·ª©c B√†</h1>
    <p class="subtitle">T√¨m <b>3 chi ti·∫øt</b> ki·∫øn tr√∫c ƒë·ªôc ƒë√°o. N·∫øu ƒëang s·ª≠a ch·ªØa, h√£y d√πng n√∫t "B√°o c√°o"!</p>
    
    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
      <div class="progress-text" id="progressText">0/3 Ho√†n th√†nh</div>
    </div>
  </header>

  <div class="grid" id="gridContainer"></div>

  <div id="nextStep">
    <h3>üéâ Ch√∫c m·ª´ng!</h3>
    <p>B·∫°n ƒë√£ kh√°m ph√° xong bi·ªÉu t∆∞·ª£ng ki·∫øn tr√∫c c·ªßa S√†i G√≤n.</p>
    <button class="btn btn-primary" onclick="window.location.href='ltbuudientp.html'">Ti·∫øp t·ª•c: B∆∞u ƒëi·ªán TP ‚Üí</button>
  </div>
</div>

<div class="modal" id="cameraModal">
  <div class="modal-content">
    <h3 id="modalTitle">T√™n hi·ªán v·∫≠t</h3>
    <p id="modalHint" style="font-size: 0.9rem; color: #666;">G·ª£i √Ω...</p>
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
    <img id="preview" class="modal-img-preview">
    <div id="actionButtons">
      <button class="btn btn-primary" onclick="document.getElementById('cameraInput').click()">üì∏ Ch·ª•p ·∫£nh ngay</button>
      <button class="btn btn-secondary" onclick="closeModal()">ƒê√≥ng</button>
      <button class="btn btn-danger" onclick="reportMissing()">‚ö†Ô∏è T√¥i kh√¥ng t√¨m th·∫•y (Do tr√πng tu)</button>
    </div>
    <div id="verifySection" style="display:none;">
      <div class="loader" id="loader"></div>
      <p id="statusMsg">ƒêang ph√¢n t√≠ch...</p>
      <button class="btn btn-primary" id="confirmBtn" style="display:none;" onclick="closeModal()">Tuy·ªát v·ªùi!</button>
      <button class="btn btn-secondary" id="retryBtn" style="display:none;" onclick="resetModal()">Th·ª≠ l·∫°i</button>
    </div>
  </div>
</div>

<script>
  // DANH S√ÅCH CHI TI·∫æT NH√Ä TH·ªú ƒê·ª®C B√Ä
  const details = [
    { id: 'mary_statue', name: 'T∆∞·ª£ng ƒê·ª©c M·∫π', icon: 'üóΩ', hint: 'ƒê·ª©ng tr√™n qu·∫£ ƒë·ªãa c·∫ßu ·ªü c√¥ng vi√™n tr∆∞·ªõc nh√† th·ªù.' },
    { id: 'bell_towers', name: 'Hai th√°p chu√¥ng', icon: '‚õ™', hint: 'ƒê·ªânh cao nh·∫•t c·ªßa nh√† th·ªù (nh√¨n t·ª´ xa).' },
    { id: 'rose_window', name: 'C·ª≠a s·ªï hoa h·ªìng', icon: 'üèµÔ∏è', hint: 'C·ª≠a s·ªï tr√≤n l·ªõn ·ªü m·∫∑t ti·ªÅn (gi·ªØa 2 th√°p).' },
    { id: 'red_brick', name: 'T∆∞·ªùng g·∫°ch ƒë·ªè', icon: 'üß±', hint: 'Lo·∫°i g·∫°ch tr·∫ßn ƒë·∫∑c tr∆∞ng t·ª´ Marseille.' },
    { id: 'main_gate', name: 'C·ªïng ch√≠nh', icon: 'üö™', hint: 'C·ªïng v√≤m l·ªõn h∆∞·ªõng ra c√¥ng vi√™n.' },
    { id: 'scaffolding', name: 'Gi√†n gi√°o (Tu s·ª≠a)', icon: 'üèóÔ∏è', hint: 'Ch·ª•p ph·∫ßn c√¥ng tr√¨nh ƒëang ƒë∆∞·ª£c che ch·∫Øn.' }
  ];

  let completedCount = 0; const targetCount = 3; let currentDetailId = null; const completedDetails = new Set();
  const grid = document.getElementById('gridContainer'); const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText'); const modal = document.getElementById('cameraModal');

  function initGrid() {
    grid.innerHTML = '';
    details.forEach(item => {
      const card = document.createElement('div');
      card.className = `card ${completedDetails.has(item.id) ? 'completed' : ''}`;
      card.onclick = () => openModal(item);
      card.innerHTML = `<span class="icon">${item.icon}</span><div class="card-title">${item.name}</div><div class="card-hint">${item.hint}</div>`;
      grid.appendChild(card);
    });
    updateProgress();
  }

  function updateProgress() {
    const pct = (completedCount / targetCount) * 100;
    progressBar.style.width = `${Math.min(pct, 100)}%`;
    progressText.innerText = `${completedCount}/${targetCount} Ho√†n th√†nh`;
    if (completedCount >= targetCount) document.getElementById('nextStep').style.display = 'block';
  }

  function openModal(item) {
    if (completedDetails.has(item.id)) return;
    currentDetailId = item.id;
    document.getElementById('modalTitle').innerText = item.name;
    document.getElementById('modalHint').innerText = item.hint;
    resetModal();
    modal.style.display = 'flex';
  }

  function closeModal() { modal.style.display = 'none'; }
  function resetModal() {
    document.getElementById('preview').style.display = 'none'; document.getElementById('preview').src = '';
    document.getElementById('actionButtons').style.display = 'block'; document.getElementById('verifySection').style.display = 'none';
    document.getElementById('cameraInput').value = '';
  }

  function reportMissing() {
    if(confirm("X√°c nh·∫≠n ch·ª•p ·∫£nh hi·ªán tr∆∞·ªùng ƒëang thi c√¥ng/tr·ªëng?")) {
      document.getElementById('cameraInput').setAttribute('data-mode', 'missing');
      document.getElementById('cameraInput').click();
    }
  }

  document.getElementById('cameraInput').addEventListener('change', function() {
      const isMissingMode = this.getAttribute('data-mode') === 'missing';
      this.removeAttribute('data-mode');
      if (this.files && this.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('preview').src = e.target.result;
            document.getElementById('preview').style.display = 'block';
            uploadAndVerify(this.files[0], isMissingMode);
        };
        reader.readAsDataURL(this.files[0]);
      }
  });

  async function uploadAndVerify(file, isReportMissing) {
    document.getElementById('actionButtons').style.display = 'none';
    document.getElementById('verifySection').style.display = 'block';
    document.getElementById('loader').style.display = 'block';
    document.getElementById('statusMsg').innerText = "AI ƒëang x·ª≠ l√Ω...";
    
    const formData = new FormData();
    formData.append('image', file);
    formData.append('detail_id', currentDetailId);
    formData.append('report_missing', isReportMissing);

    try {
      const res = await fetch('http://127.0.0.1:5000/api/verify-detail', { method: 'POST', body: formData });
      const data = await res.json();
      document.getElementById('loader').style.display = 'none';
      
      if (data.success && (data.data?.valid || data.status === 'skipped')) {
        document.getElementById('statusMsg').innerHTML = data.status === 'skipped' ? 
            `‚ö†Ô∏è ƒê√£ x√°c nh·∫≠n.` : `‚úÖ Ch√≠nh x√°c!<br><br><small>${data.data.fact}</small>`;
        markCompleted();
      } else {
        const reason = data.data ? data.data.reason : data.message;
        document.getElementById('statusMsg').innerHTML = `‚ùå Ch∆∞a ƒë√∫ng.<br>${reason}`;
        document.getElementById('retryBtn').style.display = 'inline-block';
      }
    } catch (err) {
      document.getElementById('statusMsg').innerText = "‚ùå L·ªói k·∫øt n·ªëi server.";
      document.getElementById('retryBtn').style.display = 'inline-block';
    }
  }

  function markCompleted() {
    if (completedDetails.has(currentDetailId)) return;
    completedDetails.add(currentDetailId);
    completedCount++;
    document.getElementById('confirmBtn').style.display = 'inline-block';
    initGrid();
  }

  initGrid();
</script>
</body>
</html>